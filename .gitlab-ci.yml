stages:
  - build
  - deploy

#image: spacecowboy/android-docker-builder:base
image: registry.gitlab.com/spacecowboy/feeder:builder

variables:
  GIT_SUBMODULE_STRATEGY: recursive

cache:
  key: "uber"
  paths:
     - .gradle/caches
     - .gradle/wrapper

check:
  stage: build
  script:
    - source devenv && ./gradlew assembleDebug packageDebugAndroidTest check -PdisablePreDex
  artifacts:
    paths:
    - app/build/outputs/
    - build/logs/

validate_deployment:
  stage: deploy
  script:
    - source devenv && ./deploy_playstore.sh --dry-run
# Non-tags will only perform validation
  only:
    - master

deploy_playstore:
  stage: deploy
  script:
    - source devenv && ./deploy_playstore.sh
# Non-tags will only perform validation
  only:
    - tags
#    - /^\d+\.\d+\.\d+$/
  environment:
    name: Play
    url: https://play.google.com/store/apps/details?id=com.nononsenseapps.feeder.play
